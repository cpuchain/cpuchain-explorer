<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Blockchain Explorer</title>
		<meta name="description" content="CPUchain Blockchain Explorer">

		<link rel="icon" type="image/png" href="cpuchain.png">

		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome-bundled@6.7.2/all.css" integrity="sha384-xXkvQZo+0d75L4rAc1Wje3SnTigGE9sd4i3XHVIAgz46uAI0UbLnaJLlb7soBkrO" crossorigin="anonymous">

		<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js" integrity="sha384-1H217gwSVyLSIfaLxHbE7dRb3v4mYCKbpQvzx0cegeju1MVsGrX5xXxAvs/HgeFs" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/jquery.qrcode@1.0.3/jquery.qrcode.min.js" integrity="sha384-0B/45e2to395pfnCkbfqwKFFwAa7zXdvd42eAFJa3Vm8KZ/jmHdn93XdWi//7MDS" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js" integrity="sha384-+sLIOodYLS7CIrQpBjl+C7nPvqq+FbNUBDunl/OZv93DB7Ln/533i8e/mZXLi/P+" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/moment@2.30.1/min/moment.min.js" integrity="sha384-jzJ+sNWbKe71gDLLfQKgdtslQjhK70oKLFN+wmwxyg6mQN7Vem+wzce4pryF0HP/" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/highcharts@12.2.0/highcharts.js" integrity="sha384-JEEYKZ+82Rp3Tj8kRBm8HzlbruoqzTvGBbcwUkU5++DHrQDflPR8Gs/ynOqNsKSF" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/btc-signer@1.1.1/lib/bitcoin.umd.min.js" integrity="sha384-0zuIxIaDOHI6Z6pfcTwoxlBrhrbxtQR7J/b1j4EowJI0VZL+Vi+S4QCa0jBNuQkv" crossorigin="anonymous"></script>

		<style>
			html {
				height: 100%;
			}
			html, body {
				min-height: 100%;
			}
			body {
				font-family: Arial, Helvetica, sans-serif;
				padding-top: 75px;
				padding-bottom: 56px;
				position: relative;
			}
			#logo {
				max-width: 30px;
				max-height: 30px;
				margin-top: -5px;
				margin-right: 5px;
			}
			#supply {
				cursor: pointer;
			}
			#qrCode canvas{
				max-width: 100%;
			}
			.router-page {
				display: none;
			}
			.flex-center {
				display: flex;
				align-items: center;
				justify-content: center;
			}
			@media (max-width: 991.98px) {
				.navbar-expand-lg>.container, .navbar-expand-lg>.container-fluid {
					padding-right: 15px;
					padding-left: 15px;
				}
			}
			code {
				background: #3f3f3f;
				color: #ffffff;
				padding: 3px;
				border-radius: 5px;
			}
			.modal-dialog {
				max-width: 530px;
			}
			.text-monospace {
				font-size: 14px;
			}
			small .text-monospace {
				font-size: 12px;
			}
		</style>
	</head>
	<body>
		<!-- Navbar -->
		<nav class="navbar fixed-top navbar-expand-lg navbar-dark bg-dark">
			<div class="container">
				<a href="#" class="navbar-brand">
					<img src="cpuchain.png" style="height: 30px; margin-right: 5px;"></img>CPUchain Explorer
				</a>
				<button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
					<span class="navbar-toggler-icon"></span>
				</button>
				<div class="collapse navbar-collapse" id="navbarResponsive">
					<ul class="navbar-nav ml-auto">
						<li class="nav-item">
							<a href="#" class="nav-link">Home</a>
						</li>
						<li class="nav-item">
							<a href="https://wallet.cpuchain.org/#/" target="_blank" class="nav-link">Wallet</a>
						</li>
						<li class="nav-item dropdown" id="network-list">
							<a class="nav-item nav-link dropdown-toggle" href="#" id="network-versions" data-toggle="dropdown">NETWORK</a>
						  	<div class="dropdown-menu dropdown-menu-right" aria-labelledby="network-versions" >
						  	</div>
						</li>
					</ul>
				</div>
			</div>
		</nav>

		<div class="container">
			<div class="alert alert-warning" role="alert">
				Mining Rewards for BTC-fork chain has been terminated,
				refer to <a href="https://cpuchain.org/spec/migration.html" target="_blank">migration info</a> for upcoming EVM chain migration.
			</div>
		</div>
		
		<!-- Error message and search -->
		<div class="container">
			<div id="error-message" class="alert alert-warning d-none" role="alert">
				Error, yay ∠( ᐛ 」∠)
			</div>
			<div class="card mb-3">
				<div class="card-body">
					<form id="search-form">
						<div class="input-group">
							<input type="text" id="search-field" name="search-field" class="form-control" placeholder="Block, hash, transaction, etc..." aria-label="Recipient's username" aria-describedby="button-addon2">
							<div class="input-group-append">
								<button class="btn btn-outline-dark" type="submit" id="button-addon2">Search!</button>
							</div>
						</div>
					</form>
				</div>
			</div>
		</div>
	
		<!-- Home page -->
		<div id="homepage" class="router-page">
			<div class="container">
				<div id="charts" class="card mb-3 d-none">
					<div class="card-body pb-2">
						<div>
							<div class="panel-body chart-wrapper" id="network-chart"></div>
							<div class="text-center small text-success" id="supply">
								<b>Circulating supply: <span>Loading...</span></b>
							</div>
						</div>
					</div>
				</div>
				<div class="card mb-3">
					<div class="table-responsive">
						<table id="blocks-table" class="table table-borderless table-md table-striped text-center mb-0">
							<thead>
								<tr>
									<th scope="col">Height</th>
									<th scope="col">Time</th>
									<th scope="col">Hash</th>
									<th scope="col">Transactions</th>
								</tr>
							</thead>
							<tbody>
								
							</tbody>
						</table>
					</div>
				</div>
			</div>

			<div class="flex-center">
				<button id="more" style="width: 190px;" class="btn btn-outline-dark mb-3 load-btn">
					Load more
				</button>
			</div>
		</div>
	
		<!-- Block page -->
		<div id="block" class="router-page">
			<div class="container">
				<div id="block-info-table">
					
				</div>
				<div id="block-transactions" class="mb-3"></div>
			</div>

			<div class="flex-center">
				<button id="more-block-transactions" style="width: 190px;" class="btn btn-outline-dark mb-3 load-btn d-none">
					Load more
				</button>
			</div>
		</div>
	
		<!-- Transaction page -->
		<div id="tx" class="router-page">
			<div class="container">
				<div id="tx-info-table">
					
				</div>

				<div class="card mb-3" id="tx-info-vin-total">
					<div class="card-header">
						Inputs: <b>0</b>
					</div>
					<div class="card-body">
						<div class="list-group">
						  	<div id="tx-vin-list">
						  		
						  	</div>
						</div>
					</div>
				</div>
				
				<div class="card mb-3" id="tx-info-vout-total">
					<div class="card-header">
						Outputs: <b>0</b>
					</div>
					<div class="card-body">
						<div class="list-group">
						  	<div id="tx-vout-list">

						  	</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	
		<!-- Address page -->
		<div id="address" class="router-page">
			<div class="container">
				<div id="address-info-table">
					
				</div>
				<div class="card mb-3" id="address-history">
					<div class="card-header">
						Transactions: <b>0</b>
					</div>
					<div class="card-body">
						<div class="list-group">
						  	<div id="address-history-list">
						  		
						  	</div>
						</div>
					</div>
				</div>
				<div id="address-transactions" class="mb-3"></div>
			</div>

			<div class="flex-center">
				<button id="more-address-transactions" style="width: 190px;" class="btn btn-outline-dark mb-3 load-btn d-none">
					Load more
				</button>
			</div>
		</div>
		
		<!-- QR code modal window -->
		<div id="qrModal" class="modal" tabindex="-1" role="dialog" aria-hidden="true">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<div class="col-10" style="word-wrap: break-word;">
							<b class="title"></b>
						</div>
						<div class="col-2">
							<button type="button" class="close" data-dismiss="modal" aria-label="Close">
								<span aria-hidden="true">&times;</span>
							</button>
						</div>
					</div>
					<div class="modal-body text-center">
						<div id="qrCode"></div>
					</div>
				</div>
			</div>
		</div>

		<!-- Footer :3 -->
		<footer class="mb-3">
			<div class="container text-center">
				Powered by <a target="_blank" href="https://blockbook.cpuchain.org">Blockbook API</a> |
				  <a target="_blank" href="https://github.com/cpuchain/cpuchain-explorer">Frontend Source Code</a>
			</div>
		</footer>

		<!-- All magic is here :D -->
		<script>
			// load 15 blocks per request by default, can add more blocks but it will make the page slower
			const LOAD_BLOCK = 15
			// Config
			const DEFAULT_COIN = 'CPU';
			const TESTNET_ONLY = false;

			const cookieValue = {};

			let page = '';

			var networksConfigs = {
				'CPU': {
					'name': 'CPUchain',
					'api': 'https://blockbook.cpuchain.org/api/v2',
					'ticker': 'CPU',
					'decimals': 8,
					blockTime: 60,
					reward: 50,
					halvingInterval: 1050000,
					// network object for bitcoinjs-lib to validate address
					network: {
						messagePrefix: '\x19CPUchain Signed Message:\n',
						bip32: {
							public: 0x0488b21e,
							private: 0x0488ade4
						},
						bech32: 'cpu',
						pubKeyHash: 0x1C,
						scriptHash: 0x1E,
						wif: 0x80
					}
				},
				'TCPU': {
					'name': 'CPUchain Testnet',
					'api': 'https://testnet-blockbook.cpuchain.org/api/v2',
					'ticker': 'CPU',
					'decimals': 8,
					blockTime: 60,
					reward: 50,
					halvingInterval: 1050000,
					testnet: true,
					network: {
						messagePrefix: '\x19CPUchain Signed Message:\n',
						bip32: {
							public: 0x043587CF,
							private: 0x04358394
						},
						bech32: 'tcpu',
						pubKeyHash: 0x6F,
						scriptHash: 0xC4,
						wif: 0xEF
					}
				},
			}

			let cachedBlocks = []
			let cachedBlocksPage = 0;

			// Error messages
			var errorMessages = {
				'blocks-load-error': 'There was an error while trying to load the blocks!',
				'blocks-not-found': 'Block not found!',
				'tx-not-found': 'Transaction not found!',
				'nan-error': 'The height of the block should be a non-negative integer!',
				'no-block-specified': 'You must specify blocks!',
				'no-tx-specified': 'You must specify transaction!',
				'not-valid-address': 'You must specify valid address!',
				'search-error': 'We can\'t process your request :(',
				'circulating-supply-load-error': 'There was an error while trying to load the circulating supply :('
			}

			function showCharts(data) {
				var step = 2
				if ($(document).width() < 576) {
					step = 9
				} else if ($(document).width() < 1200) {
					step = 4
				}

				$('#charts').removeClass('d-none')
				Highcharts.chart('network-chart', {
					'chart': {
						'type': 'spline',
						'height': 240,
						'marginLeft': 40, // Keep all charts left aligned
						'spacingTop': 20,
						'spacingBottom': 20
					},
					'title': {
						'text': ''
					},
					'xAxis': [{
						'categories': [].concat(data["blocks"]).reverse(),
						'crosshair': true,
						'labels': {
							'enabled': true,
							'step': step
						}
					}],
					'yAxis': [{
						'labels': {
							'enabled': false
						},
						'title': {
							'text': null
						}
					}, {
						'labels': {
							'enabled': false
						},
						'title': {
							'text': null
						}
					}, {
						'labels': {
							'enabled': false
						},
						'title': {
							'text': null
						},
						'opposite': true
					}, {
						'labels': {
							'enabled': false
						},
						'title': {
							'text': null
						}
					}, {
						'labels': {
							'enabled': false
						},
						'title': {
							'text': null
						}
					}],
					'tooltip': {
						'shared': true,
						formatter: function() {
							var s = '<b>' + this.x + '</b>';

							$.each(this.points, function(i, point) {
								text = point.y
								if (i === 3) {
									text = convertHashes(point.y)
								}

								s += '<br/><span style="color:' + point.color + '">\u25CF</span>: ' + point.series.name + ': ' + text;
							});

							return s;
						},
					},
					'plotOptions': {
						'series': {
							'animation': false,
							'label': {
								'connectorAllowed': true
							},
							'marker': {
								'enabled': false,
								'size': 2
							}
						}
					},
					'series': [{
						'name': 'Difficulty',
						'data': [].concat(data["diffs"]).reverse(),
						'yAxis': 1,
						'color': '#7cb5ec',
						'type': 'areaspline',
						'fillOpacity': 0.3
					}, {
						'name': 'Transactions',
						'data': [].concat(data["txs"]).reverse(),
						'yAxis': 2,
						'color': '#90ed7d'
					}, {
						'name': 'Size',
						'data': [].concat(data["sizes"]).reverse(),
						'yAxis': 3,
						'color': '#f7a35c'
					}, {
						'name': 'Network hashrate',
						'data': [].concat(data["nethash"]).reverse(),
						'yAxis': 4,
						'color': '#ff2a65'
					}],
					'responsive': {
						'rules': [{
							'condition': {
								'maxWidth': 500,
							},
							'chartOptions': {
								'legend': {
									'layout': 'horizontal',
									'align': 'center',
									'verticalAlign': 'bottom'
								}
							}
						}]
					}
				});
				$('.highcharts-credits').hide();
			}

			function getAddressScript(address) {
				return bitcoin.address.toOutputScript(address, getApi()['network'])
			}

			function validateAddress(address) {
				try {
					getAddressScript(address)
					return true
				} catch (e) {
					console.log(e)
					return false
				}
			}

			function getHashFromDiff(difficulty) {
				const { blockTime } = getApi()

				// https://en.bitcoin.it/wiki/Difficulty
				return Math.floor(Number(difficulty) * 2**32 / blockTime)
			}

			// Convert amount of hashes to readable form
			function convertHashes(hashes) {
				if (hashes >= 1000000000000000000000) {
					return (hashes / 1000000000000000000000).toFixed(2) + ' Zh/s'
				} else if (hashes >= 1000000000000000000) {
					return (hashes / 1000000000000000000).toFixed(2) + ' Eh/s'
				} else if (hashes >= 1000000000000000) {
					return (hashes / 1000000000000000).toFixed(2) + ' Ph/s'
				} else if (hashes >= 1000000000000) {
					return (hashes / 1000000000000).toFixed(2) + ' Th/s'
				} else if (hashes >= 1000000000) {
					return (hashes / 1000000000).toFixed(2) + ' Gh/s'
				} else if (hashes >= 1000000) {
					return (hashes / 1000000).toFixed(2) + ' Mh/s'
				} else if (hashes >= 1000) {
					return (hashes / 1000).toFixed(2) + ' Kh/s'
				} else {
					return hashes + ' H/s'
				}
			}

			function calculateSupply(height = 0) {
				const { reward, halvingInterval, ticker } = getApi();
				const halvings_count = Math.floor(height / halvingInterval);
				let supply = 0;
				let count = 0;
				let currentReward = reward;

				while (halvings_count >= count) {
					const blocks = halvings_count > count
					  ? halvingInterval
						: height % halvingInterval;

					supply += currentReward * blocks;
					currentReward = currentReward / 2;
					count++;

					// override reward for CPUchain as it has halted rewards
					if (ticker === 'CPU' && count >= 3) {
						break;
					}
				}

				return supply;
			}

			// Display doc links
			function displayDocs() {
				$('a.api-link').each(function() {
					docsLink = getApi()['api'] + docs[$(this).attr('data-docs-link')];
					$(this).attr('href', docsLink)
					$(this).text(docsLink)
				});
			}

			// Get current network config
			function getApi() {
				var network = readCookie('network')

				if (TESTNET_ONLY && !networksConfigs[network]?.testnet) {
					const testnetNetwork = Object.keys(networksConfigs).find(n => networksConfigs[n].testnet);

					return networksConfigs[testnetNetwork];
				}

				if (!network || !networksConfigs[network]) {
					setCookie('network', DEFAULT_COIN, 60)
					network = readCookie('network')
				}

				return networksConfigs[network]
			}

			// Switch network
			function switchApi(network, page = '') {
				network = network.toUpperCase()
				if (networksConfigs[network] && networksConfigs[network] !== getApi()) {
					setCookie("network", network, 60)
					cachedBlocks = [];
					cachedBlocksPage = 0;
					$('#blocks-table tbody').empty()
					$('#block-info-hash').empty()
					$('#data-address').empty()
					$('#tx-info-hash').empty()
					$('#charts').addClass('d-none')
					displayNetworks()
					displayHome()
				}
				switchPage(page)
			}

			// Display networks list
			function displayNetworks() {
				network = getApi()
				$('#network-versions').text(network['name'])
				$('#network-list .dropdown-menu').empty()

				for (var key in networksConfigs) {
					$('#network-list .dropdown-menu').append(`<a class="dropdown-item ${networksConfigs[key]['name'] === network['name'] ? 'active' : ''}" href="#/network/${key}">${networksConfigs[key]['name']}</a>`)
				}
			}

			// SPA router function
			async function routePage() {
				var urlParams = readParams()
				if (window.location.hash === '') {
					window.location.replace(window.location.href.split('#')[0] + '#/')
				}

				if (urlParams[0] === '#') {
					var pageName = urlParams[1] ? urlParams[1] : 'homepage'
					var templateName = '#' + pageName
					
					if ($('.router-page:visible').attr('id') !== urlParams[1]) {
						$('div.router-page').hide()
						if ($(templateName).length) {
							$(templateName).show()
						}
					}

					page = pageName;

					switch(pageName) {
						// Block info page
						case 'block':
							var block_hash = urlParams[2]
							var api = urlParams[3]
							var data_block_hash = $('#block-info-hash').attr('data-block-info-hash')
							if (block_hash) {
								if (api) {
									page = urlParams[1] + '/' + urlParams[2]
									switchApi(api, page)
								} else {
									if (data_block_hash !== urlParams[2]) {
										$('#block-info-tx-total').addClass('d-none')
										$('#block-info-table').empty()
										$('#block-transactions').empty()

										try {
											const block = await blockInfo(block_hash)

											displayBlockInfo(block)
											setTitle('Block #' + block.height)
										} catch (err) {
											console.log(err)
											showError(errorMessages['blocks-not-found'])
											switchPage()
										}
									} else {
										setTitle('Block #' + block_hash)
									}
								}

							} else {
								showError(errorMessages['no-block-specified'])
								switchPage()
							}

							break

						// Transaction info page
						case 'tx':
							var tx_hash = urlParams[2]
							var api = urlParams[3]
							var data_tx_hash = $('#tx-info-hash').attr('data-tx-info-hash')
							if (tx_hash) {
								if (api) {
									page = urlParams[1] + '/' + urlParams[2]
									switchApi(api, page)
								} else {
									if (data_tx_hash !== urlParams[2]) {
										$('#tx-info-vout-total').addClass('d-none')
										$('#tx-info-vin-total').addClass('d-none')
										$('#tx-info-table').empty()

										try {
											const txData = await transactionInfo(tx_hash)

											setTitle('Transaction ' + tx_hash)
											displayTransactionInfo(txData)
										} catch (err) {
											console.log(err)
											showError(errorMessages['tx-not-found'])
											switchPage()
										}
									} else {
										setTitle('Transaction ' + data_tx_hash)
									}
								}
							} else {
								showError(errorMessages['no-tx-specified'])
								switchPage()
							}

							break

						case 'address':
							var address = urlParams[2]
							var api = urlParams[3]
							var data_address = $('#data-address').attr('data-address')
							if (address) {
								if (api) {
									page = urlParams[1] + '/' + urlParams[2]
									switchApi(api, page)
								} else {
									if (data_address !== urlParams[2]) {
										$('#address-history').addClass('d-none')
										$('#address-info-table').empty()
										$('#address-transactions').empty()

										try {
											const addrData = await addressHistory(address)

											setTitle('Address ' + address)
											displayAddressInfo(addrData)
										} catch (err) {
											console.log(err)
											showError(errorMessages['not-valid-address'])
											switchPage()
										}
									} else {
										setTitle('Address ' + data_address)
									}
								}
							} else {
								showError(errorMessages['not-valid-address'])
								switchPage()
							}

							break

						// Home page ¯\_(ツ)_/¯
						case 'homepage':
							setTitle('Latest Blocks')
							displayHome()

							break

						// Swith network to explore
						case 'network':
							network = urlParams[2]
							if (network) {
								switchApi(network)
							}

							break

						default:
							switchPage()

							break
					}
				}
			}

			// Switch router page
			function switchPage(url = '', params = []) {
				params = params.length > 0 ? '/' + params.join('/') : ''
				window.location.hash = '#' + '/' + url + params;
			}

			// Read URL params
			function readParams() {
				return window.location.hash.split('/')
			}

			// Set window title
			function setTitle(title) {
				document.title = title + ` | ${getApi()['name']} Explorer`;
			}

			async function getBlockHeight() {
				const resp = await fetch(`${getApi()['api']}/block-height/`, {
					method: 'GET',
					headers: {
						'Content-Type': 'application/json'
					}
				});

				const result = await resp.json();

				return result.height
			}

			// Blocks request
			async function getBlocks(page = 0) {
				const resp = await fetch(`${getApi()['api']}/blocks/?page=${page}&pageSize=25`, {
					method: 'GET',
					headers: {
						'Content-Type': 'application/json'
					}
				});

				const result = await resp.json();

				console.log(`Fetched ${result.length} blocks (${page} page)`);

				return result.map(data => ({
					height: data.height,
					hash: data.hash,
					difficulty: Number(data.difficulty),
					nethash: getHashFromDiff(data.difficulty),
					merkleRoot: data.merkleRoot,
					nonce: data.nonce,
					previousBlockHash: data.previousBlockHash,
					size: data.size,
					time: data.time,
					txCount: data.txCount,
					version: data.version
				}))
			}

			// Block info
			async function blockInfo(block, offset = 1) {
				const resp = await fetch(`${getApi()['api']}/block/${block}?page=${offset}&pageSize=25`, {
					method: 'GET',
					headers: {
						'Content-Type': 'application/json'
					}
				});

				const data = await resp.json();
				
				return data
			}

			// Get transaction info
			async function transactionInfo(hash) {
				const resp = await fetch(`${getApi()['api']}/tx/${hash}`, {
					method: 'GET',
					headers: {
						'Content-Type': 'application/json'
					}
				});

				const data = await resp.json();
				
				return data
			}

			// Get address history
			async function addressHistory(address, offset = 1) {
				const resp = await fetch(`${getApi()['api']}/address/${address}?page=${offset}&pageSize=25&details=txs`, {
					method: 'GET',
					headers: {
						'Content-Type': 'application/json'
					}
				});

				const data = await resp.json();
				
				return data
			}

			// Get current network info
			async function networkInfo() {
				const resp = await fetch(getApi()['api'] + '/info', {
					method: 'GET',
					headers: {
						'Content-Type': 'application/json'
					}
				});

				const data = await resp.json();
				
				return data.backend
			}

			// Display stuffs here~
			function displayBlocks(blocks, prepend = false) {
				const newBlocks = prepend ? [...blocks].reverse() : [...blocks] 

				newBlocks.forEach(function(block, index) {
					if ($('tr[data-height="' + block.height + '"]').length === 0) {
						var content = `
							<tr data-height="${block.height}">
								<td>
									<a href="#/block/${block.hash}">
										${block.height}
									</a>
								</td>
								<td>
									${timeFormat(block.time)}
								</td>
								<td>
									<a href="#/block/${block.hash}">
										${block.hash}
									</a>
								</td>
								<td>
									${block.txCount}
								</td>
							</tr>`

						if (prepend) {
							$('#blocks-table tbody').prepend(content)
						} else {
							$('#blocks-table tbody').append(content)
						}
					}	

					if (block.height === 0) {
						$('#more').addClass('d-none')
					}
				});
			}

			function displayBlockInfo(data) {
				content = `
					<div class="card mb-3">
						<div class="table-responsive">
							<table class="table table-borderless table-md table-striped mb-0">
								<tbody>
									<tr>
										<td>Height</td>
										<td id="block-info-height" data-block-info-height="${data.height}">${data.height} (<b>Confirmations ${data.confirmations}</b>)</td>
									</tr>
									<tr>
										<td>Timestamp</td>
										<td>${timeFormat(data.time)} (${moment.unix(data.time).fromNow()}) (<b>${data.time}</b>)</td>
									</tr>
									<tr>
										<td>Block Hash</td>
										<td id="block-info-hash" data-block-info-hash="${data.hash}">${data.hash}</td>
									</tr>
									<tr>
										<td>Previous Block</td>
										<td>
											<a class="${'previousBlockHash' in data ? '' : 'd-none'}" href="#/block/${data.previousBlockHash}">${data.previousBlockHash}</a>
											<span class=${'previousBlockHash' in data ? 'd-none' : ''}>
												<b>Genesis Block</b>
											</span>
										</td>
									</tr>
									<tr>
										<td>Next Block</td>
										<td>
											${data.nextBlockHash ? `
												<a href="#/block/${data.nextBlockHash}">
													${data.nextBlockHash}
												</a>
											` : `
												<b>This is the latest block</b>
											`}
										</td>
									</tr>
									<tr>
										<td>Merkle Root</td>
										<td>
											${data.merkleRoot}
										</td>
									</tr>
									<tr>
										<td>Nonce</td>
										<td>${data.nonce}</td>
									</tr>
									<tr>
										<td>Version</td>
										<td>${data.version}</td>
									</tr>
									<tr>
										<td>Bits</td>
										<td>${data.bits}</td>
									</tr>
									<tr>
										<td>Size</td>
										<td>${data.size} Bytes</td>
									</tr>
									<tr>
										<td>Difficulty</td>
										<td>${data.difficulty}</td>
									</tr>
									<tr>
										<td>Transactions</td>
										<td>${data.txCount}</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>`

				$('#block-info-table').html(content)

				displayTransactions($('#block-transactions'), data.txs, data.page)

				if (data.txCount > $('#block-transactions').children().length) {
					$('#more-block-transactions').removeClass('d-none')
				} else {
					$('#more-block-transactions').addClass('d-none')
				}

				$('#block-info-tx-total').removeClass('d-none')
			}

			function displayTransactionInfo(data) {
				content = `
					<div class="card mb-3">
						<div class="table-responsive">
							<table class="table table-borderless table-md table-striped mb-0">
								<tbody>
									<tr>
										<td>Transaction Hash</td>
										<td id="tx-info-hash" data-tx-info-hash="${data.txid}">${data.txid}</td>
									</tr>
									${data.blockTime ? `
										<tr>
											<td>Timestamp</td>
											<td>${timeFormat(data.blockTime)} (${moment.unix(data.blockTime).fromNow()}) (<b>${data.blockTime}</b>)</td>
										</tr>
									` : ''}
									<tr>
										<td>Height</td>
										<td>
											${data.blockHash ? `
												<a href="#/block/${data.blockHash}">${data.blockHeight}</a> (<b>Confirmations ${data.confirmations}</b>)
											` : `
												<span class="text-danger">This transaction located in memory pool and not included to blockchain yet!</span>
											`}
										</td>
									</tr>
									<tr>
										<td>Amount Transferred</td>
										<td><span class="text-monospace">${amountFormat(Number(data.valueIn))}</span> <b>${getApi()['ticker']}</b></td>
									</tr>
									<tr>
										<td>Fees</td>
										<td><span class="text-monospace">${amountFormat(Number(data.fees))}</span> <b>${getApi()['ticker']}</b> (<b>${(Number(data.fees) / (data.vsize || data.size)).toFixed(3)} sat/vByte</b>)</td>
									</tr>
									<tr>
										<td>Size</td>
										<td>${data.size} (bytes)</td>
									</tr>
									${data.vsize ? `
									<tr>
										<td>vSize</td>
										<td>${data.vsize}</td>
									</tr>
									` : ''}
									<tr>
										<td>Version</td>
										<td>${data.version}</td>
									</tr>
									${data.lockTime ? `
									<tr>
										<td>Locktime</td>
										<td>${data.lockTime}</td>
									</tr>
									` : ''}
								</tbody>
							</table>
						</div>
					</div>`

				$('#tx-info-table').html(content)
				$('#tx-info-vout-total .card-header b').text(data.vout.length)
				$('#tx-info-vin-total .card-header b').text(data.vin.length)
				$('#tx-vout-list').empty()
				$('#tx-vin-list').empty()

				displayTxVout(data.vout, Number(data.fees))
				displayTxVin(data.vin, data.vout)

				$('#tx-info-vout-total').removeClass('d-none')
				$('#tx-info-vin-total').removeClass('d-none')
			}

			function showQrModal(e, text) {
				$('#qrCode').empty()
				$('#qrCode').qrcode(text)
				$('#qrModal .title').text(text)
				$('#qrModal').modal('toggle')
				e.preventDefault()
			}

			function displayAddressInfo(data) {
				content = `
					<div class="card mb-3">
						<div class="table-responsive">
							<table class="table table-borderless table-md table-striped mb-0">
								<tbody>
									<tr>
										<td>Address</td>
										<td id="data-address" data-address="${data.address}">
											${data.address}
											<a href="#" onclick="showQrModal(event, '${data.address}')">(QR)</a>
										</td>
									</tr>
									<tr>
										<td>Total received</td>
										<td><span class="text-monospace">${amountFormat(Number(data.totalReceived))}</span> <b>${getApi()['ticker']}</b></td>
									</tr>
									<tr>
										<td>Total sent</td>
										<td><span class="text-monospace">${amountFormat(Number(data.totalSent))}</span> <b>${getApi()['ticker']}</b></td>
									</tr>
									<tr>
										<td>Balance</td>
										<td><span class="text-monospace">${amountFormat(Number(data.balance) + Number(data.unconfirmedBalance))}</span> <b>${getApi()['ticker']}</b></td>
									</tr>
									<tr>
										<td>Txs</td>
										<td><span class="text-monospace">${data.txs}</span></td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>`

				$('#address-info-table').html(content)

				if (data.page !== data.totalPages) {
					$('#more-address-transactions').removeClass('d-none')
				} else {
					$('#more-address-transactions').addClass('d-none')
				}

				$('#address-info .address-tx-count').text(data.txs)
				displayTransactions($('#address-transactions'), data.transactions, data.page)
			}

			function parseTransactionDetails(data) {
				var status = {
					'coinbase': false,
					'input': 0,
					'output': 0,
					'fee': 0,
					'from': '',
					'to': '',
					'badge': {
						'text': '',
						'class': ''
					}
				}

				inputs = {}
				outputs = {}

				data.vin.forEach(function(vin, index) {
					const vinValue = Number(vin.value)
					if (!vin.isAddress && !vinValue) {
						status.coinbase = true
						status.from += `
							<li class="list-group-item">
								Newly Generated Coins (<b>Coinbase Transaction</b>)
							</li>`
					} else if (vinValue) {
						var address = vin.addresses[0]

						if (address in inputs) {
							inputs[address] += vinValue
						} else {
							inputs[address] = vinValue
						}

						status.input += vinValue
					}
				})

				for (address in inputs) {
					var transfer_amount = amountFormat(inputs[address]) + ' <b>' + getApi()['ticker'] + '</b>'

					content = `
						<a class="list-group-item list-group-item-action" href="#/address/${address}">
							<span class="fa-solid fa-arrow-up text-danger"></span>
							<span class="text-primary">${address}</span>
							<small class="float-right text-muted">
								<span class="text-monospace">${transfer_amount}</span>
							</small>
						</a>`

					status.from += content
				}

				data.vout.forEach(function(vout, index) {
					const voutValue = Number(vout.value)
					if (voutValue) {
						if (vout.addresses) {
							var address = vout.addresses[0]

							if (address in outputs) {
								outputs[address] += voutValue
							} else {
								outputs[address] = voutValue
							}
						}

						status.output += voutValue
					}
				})

				for (address in outputs) {
					var transfer_amount = amountFormat(outputs[address]) + ' <b>' + getApi()['ticker'] + '</b>'

					content = `
						<a class="list-group-item list-group-item-action" href="#/address/${address}">
							<span class="fa-solid fa-arrow-down text-success"></span>
							<span class="text-primary">${address}</span>
							<small class="float-right text-muted">
								<span class="text-monospace">${transfer_amount}</span>
							</small>
						</a>`

					status.to += content
				}

				if (!status.coinbase) {
					status.fee = status.input - status.output
					content = `
					  <li class="list-group-item">
							<b>Output:</b>
							<small class="float-right text-muted">
								<span class="text-monospace">${amountFormat(status.output)}</span> <b>${getApi()['ticker']}</b>
							</small>
						</li>
						<li class="list-group-item">
							<b>Total fee:</b>
							<small class="float-right text-muted">
								<span class="text-monospace">${amountFormat(status.fee)}</span> <b>${getApi()['ticker']}</b>
							</small>
						</li>
					`

					status.to += content
				}

				if (status.coinbase) {
					status.badge.text = 'Coinbase'
					status.badge.class = 'badge-primary'
				}

				return status
			}

			function loadTransactions(holder, data) {
				holder.find('[data-transaction][data-transaction-loaded=false]').each(async function() {
					try {
						var tx = $(this)
						const txid = tx.attr('data-transaction')
						const txData = data?.find(t => t.txid === txid) || await transactionInfo(tx.attr('data-transaction'))

						tx.find('.transaction-time').text(timeFormat(txData.blockTime)).removeClass('d-none')

						const status = parseTransactionDetails(txData)
						if (status.hide) {
							tx.addClass('d-none')
						} else {
							tx.find('hr').removeClass('d-none')
							tx.find('.transaction-from').removeClass('d-none')
							tx.find('.transaction-to').removeClass('d-none')
							
							tx.find('.transaction-badge .badge').text(status.badge.text).removeClass('d-none')
							tx.find('.transaction-badge .badge').addClass(status.badge.class)
							tx.find('.transaction-badge').removeClass('d-none')
							
							tx.find('.transaction-from ul').append(status.from)
							tx.find('.transaction-to ul').append(status.to)
						}
						tx.attr('data-transaction-loaded', true)
					} catch (err) {
						console.log(err)
					}
				})
			}

			function displayTransactions(holder, data = [], offset = 1) {
				data.forEach(function(tx) {
					content = `
						<div class="card mt-3 light-shadow" data-transaction="${tx.txid}" data-transaction-index="${offset}" data-transaction-loaded="false">
							<div class="card-header">
								Transaction: <a href="#/tx/${tx.txid}">
									${tx.txid}
								</a>
								<span class="transaction-badge">
									<span class="ml-1 badge"></span>
								</span>
								<div class="float-right">
									<span class="transaction-time"></span>
								</div>
							</div>
							<div class="card-body">
								<div class="row">
									<div class="col-12 transaction-from d-none">
										<ul class="list-group mb-3">
											<li class="list-group-item disabled">
												<b>Inputs</b>
											</li>
										</ul>
									</div>
									<div class="col-12 transaction-to d-none">
										<ul class="list-group">
											<li class="list-group-item disabled">
												<b>Outputs</b>
											</li>
										</ul>
									</div>
								</div>
							</div>
						</div>`
					holder.append(content)
				})

				if (data.length > 0) {
					$('#more-block-transactions').removeClass('d-none')
				} else {
					$('#more-block-transactions').addClass('d-none')
				}

				loadTransactions(holder, data)
			}

			function displayTxVout(vout_list, fee = 0) {
				vout_list.forEach(function(vout, index) {
					if ($('#tx-vout-list').find(`[data-tx-vout-index="${index}"]`).length === 0) {
						if (vout.isAddress) {
							var content = `
								<a href="#/address/${vout.addresses[0]}" data-tx-vout-index="${index}" class="list-group-item list-group-item-action flex-column align-items-start">
									<div class="row">
										<div class="col-md-9 col-sm-12 col-xs-12">
											<span class="text-muted mr-1">
												<span class="fa-solid fa-arrow-down text-success"></span>
											</span>
											<span class="text-primary">${vout.addresses[0]}</span>
										</div>
										<div class="col-md-3 col-sm-12 col-xs-12 text-md-right">
											<small class="text-muted">
												<span class="text-monospace">${amountFormat(Number(vout.value))}</span> <b>${getApi()['ticker']}</b>
											</small>
										</div>
									</div>
								</a>`

							$('#tx-vout-list').append(content)
						} else {
							var content = `
								<li class="list-group-item">
									<code>${vout.addresses?.[0] || vout.hex}</code>
								</li>
							`

							$('#tx-vout-list').append(content)
						}
					}
				})

				if (fee > 0) {
					$('#tx-vout-list').append(`
						<li class="list-group-item">
							<b>Total fee:</b>
							<small class="float-right text-muted">
								<span class="text-monospace">${amountFormat(fee)}</span> <b>${getApi()['ticker']}</b>
							</small>
						</li>
					`)
				}
			}

			function hex2a(hexx) {
				var hex = String(hexx);
				var str = '';
				for (var i = 0; i < hex.length; i += 2) {
					str += String.fromCharCode(parseInt(hex.substr(i, 2), 16));
				}
				return str;
			}

			function displayTxVin(vin_list, vout_list) {
				var total = $('#tx-info-vin-total .card-header b').text()
				vin_list.forEach(function(vin, index) {
					if (vin.coinbase) {
						const rewards = (vout_list || []).reduce((acc, curr) => acc + Number(curr?.value || 0), 0);

						var content = `
							<div class="list-group-item flex-column align-items-start" data-tx-vin-index="${index}">
								<div class="row">
									<div class="col-md-9 col-sm-12 col-xs-12">
										<span class="text-muted mr-1">
											<span class="fa-solid fa-arrow-up text-danger"></span>
										</span>
										<code>${hex2a(vin.coinbase)}</code> (<b>Coinbase Transaction</b>)
									</div>
									<div class="col-md-3 col-sm-12 col-xs-12 text-md-right">
										<small class="text-muted">
											<span class="text-monospace">${amountFormat(rewards)}</span> <b>${getApi()['ticker']}</b>
										</small>
									</div>
								</div>
							</div>`

						$('#tx-vin-list').append(content)

					} else {
						if ($('#tx-vin-list').find(`[data-tx-vin-index="${index}"]`).length === 0) {
							var content = `
							<div class="list-group-item flex-column align-items-start" data-tx-vin-index="${index}">
								<div class="row">
									<div class="col-md-9 col-sm-12 col-xs-12">
										<span class="text-muted mr-1">
											<span class="fa-solid fa-arrow-up text-danger"></span>
										</span>
										<a href="#/address/${vin.addresses[0]}">
											${vin.addresses[0]}
										</a>
										(<a href="#/tx/${vin['txid']}">Output</a>)
									</div>
									<div class="col-md-3 col-sm-12 col-xs-12 text-md-right">
										<small class="text-muted">
											<span class="text-monospace">${amountFormat(Number(vin.value))}</span> <b>${getApi()['ticker']}</b>
										</small>
									</div>
								</div>
							</div>`

							$('#tx-vin-list').append(content)
						}
					}
				})
			}

			function drawChart() {
				const chart_data = {
						'diffs': [],
						'blocks': [],
						'sizes': [],
						'timestamps': [],
						'txs': [],
						'nethash': []
					}

					cachedBlocks.forEach((block) => {
						chart_data['diffs'].push(block['difficulty'])
						chart_data['blocks'].push(block['height'])
						chart_data['sizes'].push(block['size'])
						chart_data['timestamps'].push(block['time'])
						chart_data['txs'].push(block['txCount'])
						chart_data['nethash'].push(block['nethash'])
					})

					showCharts(chart_data)
			}

			async function displayHome() {
				try {
					const blockHeight = await getBlockHeight();

					if (blockHeight === cachedBlocks[0]?.height) {
						return;
					}

					$('#supply span').text('Loading...')
					const circulatingSupply = calculateSupply(blockHeight)

					$('#supply span').text(circulatingSupply.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',') + ' ' + getApi()['ticker'])

					const blocks = await getBlocks()

					const uniqueBlocks = new Set();

					cachedBlocks = [
						...blocks,
						...cachedBlocks
					].filter(b => {
						if (!uniqueBlocks.has(b.hash)) {
							uniqueBlocks.add(b.hash)
							return true
						}
						return false
					})

					displayBlocks(blocks, true)
					drawChart()
				} catch (err) {
					console.log(err)
					showError(errorMessages['blocks-load-error'])
				}
			}

			// Set cookie
			function setCookie(name, value, days) {
				if (location.protocol === 'file:') {
					cookieValue[name] = value;
				}

				var expires;

				if (days) {
					var date = new Date();
					date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
					expires = '; expires=' + date.toGMTString();
				} else {
					expires = '';
				}
				document.cookie = encodeURIComponent(name) + '=' + encodeURIComponent(value) + expires + '; path=/';
			}

			// Read cookie
			function readCookie(name) {
				if (location.protocol === 'file:') {
					return cookieValue[name];
				}

				var nameEQ = encodeURIComponent(name) + '=';
				var ca = document.cookie.split(';');
				for (var i = 0; i < ca.length; i++) {
					var c = ca[i];
					while (c.charAt(0) === ' ') c = c.substring(1, c.length);
					if (c.indexOf(nameEQ) === 0) return decodeURIComponent(c.substring(nameEQ.length, c.length));
				}
				return null;
			}

			// Check if variable is number lol
			function isNumeric(num){
				return !isNaN(num)
			}

			// Convert satoshis to readable amount
			function amountFormat(amount) {
				var decimals = getApi()['decimals']
				return parseFloat((amount / Math.pow(10, decimals)).toFixed(decimals))
			}

			// Convert timestamp to readable date
			function timeFormat(timestamp) {	 
				var months_arr = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']
				var date = new Date(timestamp * 1000)
				var year = date.getFullYear()
				var month = months_arr[date.getMonth()]
				var day = date.getDate()
				var hours = date.getHours()
				var minutes = '0' + date.getMinutes()
				var seconds = '0' + date.getSeconds()
				var convdataTime = month + '-' + day + '-' + year + ' ' + hours + ':' + minutes.substr(-2) + ':' + seconds.substr(-2)

				return convdataTime
			}

			// Show big error message at the top of the page :D 
			function showError(message) {
				$('#error-message').text(message)
				$('#error-message').removeClass('d-none')
				setTimeout(function() {
					$('#error-message').addClass('d-none')
				}, 3400);
			}

			function initRouter() {
				routePage()
				window.router = false
				$(window).on('hashchange', routePage)
				if (window.location.hash) {
					if (window.router) {
						$(window).trigger('hashchange')
					}
					window.router = true
				}
			}

			// All starts here
			$(document).ready(function() {
				initRouter()
				displayNetworks()

				$('#more').click(async function() {
					try {
						cachedBlocksPage++;
						const blocks = await getBlocks(cachedBlocksPage)
						
						const uniqueBlocks = new Set();
						
						cachedBlocks = [
							...cachedBlocks,
							...blocks
						].filter(b => {
							if (!uniqueBlocks.has(b.hash)) {
								uniqueBlocks.add(b.hash)
								return true
							}
							return false
						})
						
						displayBlocks(blocks)
						drawChart()
					} catch (err) {
						console.log(err)
					}
				})

				$('#more-block-transactions').click(async function() {
					const data_block_hash = $('#block-info-hash').text()
					const offset = Number($('#block-transactions [data-transaction-index]').last().attr('data-transaction-index')) + 1

					const blockData = await blockInfo(data_block_hash, offset)

					if (blockData.page !== blockData.totalPages) {
						$(this).removeClass('d-none')
					} else {
						$(this).addClass('d-none')
					}
					
					displayTransactions($('#block-transactions'), blockData.txs, offset)
				})

				$('#more-address-transactions').click(async function() {
					const data_address_link = $('#data-address').attr('data-address')
					const offset = Number($('#address-transactions [data-transaction-index]').last().attr('data-transaction-index')) + 1

					const addrData = await addressHistory(data_address_link, offset)

					if (addrData.page !== addrData.totalPages) {
						$(this).removeClass('d-none')
					} else {
						$(this).addClass('d-none')
					}
					
					displayTransactions($('#address-transactions'), addrData.transactions, offset)
				})

				$('#search-form').submit(async function(e) {
					e.preventDefault()
					var search = $('#search-form input').val().trim()

					if (search) {
						let searchType = ''

						try {
							if (isNumeric(search)) {
								await blockInfo(search)
								searchType = 'block'
							} else if (search.length === 64) {
								try {
									await blockInfo(search)
									searchType = 'block'
								} catch {
									await transactionInfo(search)
									searchType = 'tx'
								}
							} else {
								validateAddress(search)
								searchType = 'address'
							}
						} catch (err) {
							console.log(err)
							showError(errorMessages['search-error'])
						}

						switchPage(searchType, [search])
						$('#search-form input').val('')
					}
				})

				window.setInterval(function() {
					if (page === 'homepage') {
						displayHome();
					}
				}, getApi().blockTime * 1000);
			})
		</script>
	</body>
</html>
